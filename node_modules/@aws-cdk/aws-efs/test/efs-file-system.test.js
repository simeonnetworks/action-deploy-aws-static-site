"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
const ec2 = require("@aws-cdk/aws-ec2");
const kms = require("@aws-cdk/aws-kms");
const core_1 = require("@aws-cdk/core");
const lib_1 = require("../lib");
let stack = new core_1.Stack();
let vpc = new ec2.Vpc(stack, 'VPC');
beforeEach(() => {
    stack = new core_1.Stack();
    vpc = new ec2.Vpc(stack, 'VPC');
});
test('default file system is created correctly', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        DeletionPolicy: 'Retain',
        UpdateReplacePolicy: 'Retain',
    }, assert_1.ResourcePart.CompleteDefinition));
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::MountTarget'));
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EC2::SecurityGroup'));
});
test('unencrypted file system is created correctly with default KMS', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        encrypted: false,
    });
    // THEN
    assert_1.expect(stack).notTo(assert_1.haveResource('AWS::EFS::FileSystem', {
        Encrypted: true,
    }));
});
test('encrypted file system is created correctly with default KMS', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        encrypted: true,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        Encrypted: true,
    }));
});
test('encrypted file system is created correctly with custom KMS', () => {
    const key = new kms.Key(stack, 'customKeyFS');
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        encrypted: true,
        kmsKey: key,
    });
    // THEN
    /*
     * CDK appends 8-digit MD5 hash of the resource path to the logical Id of the resource in order to make sure
     * that the id is unique across multiple stacks. There isnt a direct way to identify the exact name of the resource
     * in generated CDK, hence hardcoding the MD5 hash here for assertion. Assumption is that the path of the Key wont
     * change in this UT. Checked the unique id by generating the cloud formation stack.
     */
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        Encrypted: true,
        KmsKeyId: {
            Ref: 'customKeyFSDDB87C6D',
        },
    }));
});
test('file system is created correctly with life cycle property', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        lifecyclePolicy: lib_1.LifecyclePolicy.AFTER_14_DAYS,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        LifecyclePolicies: [{
                TransitionToIA: 'AFTER_14_DAYS',
            }],
    }));
});
test('file system is created correctly with performance mode', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        performanceMode: lib_1.PerformanceMode.MAX_IO,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        PerformanceMode: 'maxIO',
    }));
});
test('file system is created correctly with bursting throughput mode', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        throughputMode: lib_1.ThroughputMode.BURSTING,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        ThroughputMode: 'bursting',
    }));
});
test('Exception when throughput mode is set to PROVISIONED, but provisioned throughput is not set', () => {
    expect(() => {
        new lib_1.FileSystem(stack, 'EfsFileSystem', {
            vpc,
            throughputMode: lib_1.ThroughputMode.PROVISIONED,
        });
    }).toThrowError(/Property provisionedThroughputPerSecond is required when throughputMode is PROVISIONED/);
});
test('fails when provisioned throughput is less than the valid range', () => {
    expect(() => new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        throughputMode: lib_1.ThroughputMode.PROVISIONED,
        provisionedThroughputPerSecond: core_1.Size.kibibytes(10),
    })).toThrow(/cannot be converted into a whole number/);
});
test('fails when provisioned throughput is not a whole number of mebibytes', () => {
    expect(() => {
        new lib_1.FileSystem(stack, 'EfsFileSystem2', {
            vpc,
            throughputMode: lib_1.ThroughputMode.PROVISIONED,
            provisionedThroughputPerSecond: core_1.Size.kibibytes(2050),
        });
    }).toThrowError(/cannot be converted into a whole number/);
});
test('file system is created correctly with provisioned throughput mode', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
        throughputMode: lib_1.ThroughputMode.PROVISIONED,
        provisionedThroughputPerSecond: core_1.Size.mebibytes(5),
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        ThroughputMode: 'provisioned',
        ProvisionedThroughputInMibps: 5,
    }));
});
test('existing file system is imported correctly', () => {
    // WHEN
    const fs = lib_1.FileSystem.fromFileSystemAttributes(stack, 'existingFS', {
        fileSystemId: 'fs123',
        securityGroup: ec2.SecurityGroup.fromSecurityGroupId(stack, 'SG', 'sg-123456789', {
            allowAllOutbound: false,
        }),
    });
    fs.connections.allowToAnyIpv4(ec2.Port.tcp(443));
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EC2::SecurityGroupEgress', {
        GroupId: 'sg-123456789',
    }));
});
test('support tags', () => {
    // WHEN
    const fileSystem = new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
    });
    core_1.Tag.add(fileSystem, 'Name', 'LookAtMeAndMyFancyTags');
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        FileSystemTags: [
            { Key: 'Name', Value: 'LookAtMeAndMyFancyTags' },
        ],
    }));
});
test('file system is created correctly when given a name', () => {
    // WHEN
    new lib_1.FileSystem(stack, 'EfsFileSystem', {
        fileSystemName: 'MyNameableFileSystem',
        vpc,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        FileSystemTags: [
            { Key: 'Name', Value: 'MyNameableFileSystem' },
        ],
    }));
});
test('auto-named if none provided', () => {
    // WHEN
    const fileSystem = new lib_1.FileSystem(stack, 'EfsFileSystem', {
        vpc,
    });
    // THEN
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        FileSystemTags: [
            { Key: 'Name', Value: fileSystem.node.path },
        ],
    }));
});
test('removalPolicy is DESTROY', () => {
    new lib_1.FileSystem(stack, 'EfsFileSystem', { vpc, removalPolicy: core_1.RemovalPolicy.DESTROY });
    assert_1.expect(stack).to(assert_1.haveResource('AWS::EFS::FileSystem', {
        DeletionPolicy: 'Delete',
        UpdateReplacePolicy: 'Delete',
    }, assert_1.ResourcePart.CompleteDefinition));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWZzLWZpbGUtc3lzdGVtLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJlZnMtZmlsZS1zeXN0ZW0udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUFrRjtBQUNsRix3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBQ3hDLHdDQUFnRTtBQUNoRSxnQ0FBc0Y7QUFFdEYsSUFBSSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztBQUN4QixJQUFJLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBRXBDLFVBQVUsQ0FBRSxHQUFHLEVBQUU7SUFDZixLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUNwQixHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNsQyxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQywwQ0FBMEMsRUFBRSxHQUFHLEVBQUU7SUFDcEQsT0FBTztJQUNQLElBQUksZ0JBQVUsQ0FBQyxLQUFLLEVBQUUsZUFBZSxFQUFFO1FBQ3JDLEdBQUc7S0FDSixDQUFDLENBQUM7SUFDSCxPQUFPO0lBQ1AsZUFBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBWSxDQUFDLHNCQUFzQixFQUFFO1FBQ3ZELGNBQWMsRUFBRSxRQUFRO1FBQ3hCLG1CQUFtQixFQUFFLFFBQVE7S0FDOUIsRUFBRSxxQkFBWSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUNyQyxlQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLHFCQUFZLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDO0lBQzNELGVBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7QUFDL0QsQ0FBQyxDQUFDLENBQUM7QUFFSCxJ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QUFFLEdBQUcsRUFBRTtJQUNwQyxJQUFJLGdCQUFVLENBQUMsS0FBSyxFQUFFLGVBQWUsRUFBRSxFQUFDLEdBQUcsRUFBRSxhQUFhLEVBQUUsb0JBQWEsQ0FBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO0lBRXBGLGVBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQyxzQkFBc0IsRUFBRTtRQUN2RCxjQUFjLEVBQUUsUUFBUTtRQUN4QixtQkFBbUIsRUFBRSxRQUFRO0tBQzlCLEVBQUUscUJBQVksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7QUFFdkMsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHBlY3QgYXMgZXhwZWN0Q0RLLCBoYXZlUmVzb3VyY2UsIFJlc291cmNlUGFydCB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydCc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBrbXMgZnJvbSAnQGF3cy1jZGsvYXdzLWttcyc7XG5pbXBvcnQgeyBSZW1vdmFsUG9saWN5LCBTaXplLCBTdGFjaywgVGFnIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgeyBGaWxlU3lzdGVtLCBMaWZlY3ljbGVQb2xpY3ksIFBlcmZvcm1hbmNlTW9kZSwgVGhyb3VnaHB1dE1vZGUgfSBmcm9tICcuLi9saWInO1xuXG5sZXQgc3RhY2sgPSBuZXcgU3RhY2soKTtcbmxldCB2cGMgPSBuZXcgZWMyLlZwYyhzdGFjaywgJ1ZQQycpO1xuXG5iZWZvcmVFYWNoKCAoKSA9PiB7XG4gIHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIHZwYyA9IG5ldyBlYzIuVnBjKHN0YWNrLCAnVlBDJyk7XG59KTtcblxudGVzdCgnZGVmYXVsdCBmaWxlIHN5c3RlbSBpcyBjcmVhdGVkIGNvcnJlY3RseScsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgdnBjLFxuICB9KTtcbiAgLy8gVEhFTlxuICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpFRlM6OkZpbGVTeXN0ZW0nLCB7XG4gICAgRGVsZXRpb25Qb2xpY3k6ICdSZXRhaW4nLFxuICAgIFVwZGF0ZVJlcGxhY2VQb2xpY3k6ICdSZXRhaW4nLFxuICB9LCBSZXNvdXJjZVBhcnQuQ29tcGxldGVEZWZpbml0aW9uKSk7XG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVGUzo6TW91bnRUYXJnZXQnKSk7XG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVDMjo6U2VjdXJpdHlHcm91cCcpKTtcbn0pO1xuXG50ZXN0KCd1bmVuY3J5cHRlZCBmaWxlIHN5c3RlbSBpcyBjcmVhdGVkIGNvcnJlY3RseSB3aXRoIGRlZmF1bHQgS01TJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBGaWxlU3lzdGVtKHN0YWNrLCAnRWZzRmlsZVN5c3RlbScsIHtcbiAgICB2cGMsXG4gICAgZW5jcnlwdGVkOiBmYWxzZSxcbiAgfSk7XG4gIC8vIFRIRU5cbiAgZXhwZWN0Q0RLKHN0YWNrKS5ub3RUbyhoYXZlUmVzb3VyY2UoJ0FXUzo6RUZTOjpGaWxlU3lzdGVtJywge1xuICAgIEVuY3J5cHRlZDogdHJ1ZSxcbiAgfSkpO1xufSk7XG5cbnRlc3QoJ2VuY3J5cHRlZCBmaWxlIHN5c3RlbSBpcyBjcmVhdGVkIGNvcnJlY3RseSB3aXRoIGRlZmF1bHQgS01TJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBGaWxlU3lzdGVtKHN0YWNrLCAnRWZzRmlsZVN5c3RlbScsIHtcbiAgICB2cGMsXG4gICAgZW5jcnlwdGVkOiB0cnVlLFxuICB9KTtcbiAgLy8gVEhFTlxuICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpFRlM6OkZpbGVTeXN0ZW0nLCB7XG4gICAgRW5jcnlwdGVkOiB0cnVlLFxuICB9KSk7XG59KTtcblxudGVzdCgnZW5jcnlwdGVkIGZpbGUgc3lzdGVtIGlzIGNyZWF0ZWQgY29ycmVjdGx5IHdpdGggY3VzdG9tIEtNUycsICgpID0+IHtcbiAgY29uc3Qga2V5ID0gbmV3IGttcy5LZXkoc3RhY2ssICdjdXN0b21LZXlGUycpO1xuXG4gIC8vIFdIRU5cbiAgbmV3IEZpbGVTeXN0ZW0oc3RhY2ssICdFZnNGaWxlU3lzdGVtJywge1xuICAgIHZwYyxcbiAgICBlbmNyeXB0ZWQ6IHRydWUsXG4gICAga21zS2V5OiBrZXksXG4gIH0pO1xuICAvLyBUSEVOXG5cbiAgLypcbiAgICogQ0RLIGFwcGVuZHMgOC1kaWdpdCBNRDUgaGFzaCBvZiB0aGUgcmVzb3VyY2UgcGF0aCB0byB0aGUgbG9naWNhbCBJZCBvZiB0aGUgcmVzb3VyY2UgaW4gb3JkZXIgdG8gbWFrZSBzdXJlXG4gICAqIHRoYXQgdGhlIGlkIGlzIHVuaXF1ZSBhY3Jvc3MgbXVsdGlwbGUgc3RhY2tzLiBUaGVyZSBpc250IGEgZGlyZWN0IHdheSB0byBpZGVudGlmeSB0aGUgZXhhY3QgbmFtZSBvZiB0aGUgcmVzb3VyY2VcbiAgICogaW4gZ2VuZXJhdGVkIENESywgaGVuY2UgaGFyZGNvZGluZyB0aGUgTUQ1IGhhc2ggaGVyZSBmb3IgYXNzZXJ0aW9uLiBBc3N1bXB0aW9uIGlzIHRoYXQgdGhlIHBhdGggb2YgdGhlIEtleSB3b250XG4gICAqIGNoYW5nZSBpbiB0aGlzIFVULiBDaGVja2VkIHRoZSB1bmlxdWUgaWQgYnkgZ2VuZXJhdGluZyB0aGUgY2xvdWQgZm9ybWF0aW9uIHN0YWNrLlxuICAgKi9cbiAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6RUZTOjpGaWxlU3lzdGVtJywge1xuICAgIEVuY3J5cHRlZDogdHJ1ZSxcbiAgICBLbXNLZXlJZDoge1xuICAgICAgUmVmOiAnY3VzdG9tS2V5RlNEREI4N0M2RCcsXG4gICAgfSxcbiAgfSkpO1xufSk7XG5cbnRlc3QoJ2ZpbGUgc3lzdGVtIGlzIGNyZWF0ZWQgY29ycmVjdGx5IHdpdGggbGlmZSBjeWNsZSBwcm9wZXJ0eScsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgdnBjLFxuICAgIGxpZmVjeWNsZVBvbGljeTogTGlmZWN5Y2xlUG9saWN5LkFGVEVSXzE0X0RBWVMsXG4gIH0pO1xuICAvLyBUSEVOXG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVGUzo6RmlsZVN5c3RlbScsIHtcbiAgICBMaWZlY3ljbGVQb2xpY2llczogW3tcbiAgICAgIFRyYW5zaXRpb25Ub0lBOiAnQUZURVJfMTRfREFZUycsXG4gICAgfV0sXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCdmaWxlIHN5c3RlbSBpcyBjcmVhdGVkIGNvcnJlY3RseSB3aXRoIHBlcmZvcm1hbmNlIG1vZGUnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgbmV3IEZpbGVTeXN0ZW0oc3RhY2ssICdFZnNGaWxlU3lzdGVtJywge1xuICAgIHZwYyxcbiAgICBwZXJmb3JtYW5jZU1vZGU6IFBlcmZvcm1hbmNlTW9kZS5NQVhfSU8sXG4gIH0pO1xuICAvLyBUSEVOXG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVGUzo6RmlsZVN5c3RlbScsIHtcbiAgICBQZXJmb3JtYW5jZU1vZGU6ICdtYXhJTycsXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCdmaWxlIHN5c3RlbSBpcyBjcmVhdGVkIGNvcnJlY3RseSB3aXRoIGJ1cnN0aW5nIHRocm91Z2hwdXQgbW9kZScsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgdnBjLFxuICAgIHRocm91Z2hwdXRNb2RlOiBUaHJvdWdocHV0TW9kZS5CVVJTVElORyxcbiAgfSk7XG4gIC8vIFRIRU5cbiAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6RUZTOjpGaWxlU3lzdGVtJywge1xuICAgIFRocm91Z2hwdXRNb2RlOiAnYnVyc3RpbmcnLFxuICB9KSk7XG59KTtcblxudGVzdCgnRXhjZXB0aW9uIHdoZW4gdGhyb3VnaHB1dCBtb2RlIGlzIHNldCB0byBQUk9WSVNJT05FRCwgYnV0IHByb3Zpc2lvbmVkIHRocm91Z2hwdXQgaXMgbm90IHNldCcsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IHtcbiAgICBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgICB2cGMsXG4gICAgICB0aHJvdWdocHV0TW9kZTogVGhyb3VnaHB1dE1vZGUuUFJPVklTSU9ORUQsXG4gICAgfSk7XG4gIH0pLnRvVGhyb3dFcnJvcigvUHJvcGVydHkgcHJvdmlzaW9uZWRUaHJvdWdocHV0UGVyU2Vjb25kIGlzIHJlcXVpcmVkIHdoZW4gdGhyb3VnaHB1dE1vZGUgaXMgUFJPVklTSU9ORUQvKTtcbn0pO1xuXG50ZXN0KCdmYWlscyB3aGVuIHByb3Zpc2lvbmVkIHRocm91Z2hwdXQgaXMgbGVzcyB0aGFuIHRoZSB2YWxpZCByYW5nZScsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IG5ldyBGaWxlU3lzdGVtKHN0YWNrLCAnRWZzRmlsZVN5c3RlbScsIHtcbiAgICB2cGMsXG4gICAgdGhyb3VnaHB1dE1vZGU6IFRocm91Z2hwdXRNb2RlLlBST1ZJU0lPTkVELFxuICAgIHByb3Zpc2lvbmVkVGhyb3VnaHB1dFBlclNlY29uZDogU2l6ZS5raWJpYnl0ZXMoMTApLFxuICB9KSkudG9UaHJvdygvY2Fubm90IGJlIGNvbnZlcnRlZCBpbnRvIGEgd2hvbGUgbnVtYmVyLyk7XG59KTtcblxudGVzdCgnZmFpbHMgd2hlbiBwcm92aXNpb25lZCB0aHJvdWdocHV0IGlzIG5vdCBhIHdob2xlIG51bWJlciBvZiBtZWJpYnl0ZXMnLCAoKSA9PiB7XG4gIGV4cGVjdCgoKSA9PiB7XG4gICAgbmV3IEZpbGVTeXN0ZW0oc3RhY2ssICdFZnNGaWxlU3lzdGVtMicsIHtcbiAgICAgIHZwYyxcbiAgICAgIHRocm91Z2hwdXRNb2RlOiBUaHJvdWdocHV0TW9kZS5QUk9WSVNJT05FRCxcbiAgICAgIHByb3Zpc2lvbmVkVGhyb3VnaHB1dFBlclNlY29uZDogU2l6ZS5raWJpYnl0ZXMoMjA1MCksXG4gICAgfSk7XG4gIH0pLnRvVGhyb3dFcnJvcigvY2Fubm90IGJlIGNvbnZlcnRlZCBpbnRvIGEgd2hvbGUgbnVtYmVyLyk7XG59KTtcblxudGVzdCgnZmlsZSBzeXN0ZW0gaXMgY3JlYXRlZCBjb3JyZWN0bHkgd2l0aCBwcm92aXNpb25lZCB0aHJvdWdocHV0IG1vZGUnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgbmV3IEZpbGVTeXN0ZW0oc3RhY2ssICdFZnNGaWxlU3lzdGVtJywge1xuICAgIHZwYyxcbiAgICB0aHJvdWdocHV0TW9kZTogVGhyb3VnaHB1dE1vZGUuUFJPVklTSU9ORUQsXG4gICAgcHJvdmlzaW9uZWRUaHJvdWdocHV0UGVyU2Vjb25kOiBTaXplLm1lYmlieXRlcyg1KSxcbiAgfSk7XG4gIC8vIFRIRU5cbiAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6RUZTOjpGaWxlU3lzdGVtJywge1xuICAgIFRocm91Z2hwdXRNb2RlOiAncHJvdmlzaW9uZWQnLFxuICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dEluTWlicHM6IDUsXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCdleGlzdGluZyBmaWxlIHN5c3RlbSBpcyBpbXBvcnRlZCBjb3JyZWN0bHknLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgY29uc3QgZnMgPSBGaWxlU3lzdGVtLmZyb21GaWxlU3lzdGVtQXR0cmlidXRlcyhzdGFjaywgJ2V4aXN0aW5nRlMnLCB7XG4gICAgZmlsZVN5c3RlbUlkOiAnZnMxMjMnLFxuICAgIHNlY3VyaXR5R3JvdXA6IGVjMi5TZWN1cml0eUdyb3VwLmZyb21TZWN1cml0eUdyb3VwSWQoc3RhY2ssICdTRycsICdzZy0xMjM0NTY3ODknLCB7XG4gICAgICBhbGxvd0FsbE91dGJvdW5kOiBmYWxzZSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgZnMuY29ubmVjdGlvbnMuYWxsb3dUb0FueUlwdjQoZWMyLlBvcnQudGNwKDQ0MykpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6RUMyOjpTZWN1cml0eUdyb3VwRWdyZXNzJywge1xuICAgIEdyb3VwSWQ6ICdzZy0xMjM0NTY3ODknLFxuICB9KSk7XG59KTtcblxudGVzdCgnc3VwcG9ydCB0YWdzJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGZpbGVTeXN0ZW0gPSBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgdnBjLFxuICB9KTtcbiAgVGFnLmFkZChmaWxlU3lzdGVtLCAnTmFtZScsICdMb29rQXRNZUFuZE15RmFuY3lUYWdzJyk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3RDREsoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpFRlM6OkZpbGVTeXN0ZW0nLCB7XG4gICAgRmlsZVN5c3RlbVRhZ3M6IFtcbiAgICAgIHtLZXk6ICdOYW1lJywgVmFsdWU6ICdMb29rQXRNZUFuZE15RmFuY3lUYWdzJ30sXG4gICAgXSxcbiAgfSkpO1xufSk7XG5cbnRlc3QoJ2ZpbGUgc3lzdGVtIGlzIGNyZWF0ZWQgY29ycmVjdGx5IHdoZW4gZ2l2ZW4gYSBuYW1lJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBGaWxlU3lzdGVtKHN0YWNrLCAnRWZzRmlsZVN5c3RlbScsIHtcbiAgICBmaWxlU3lzdGVtTmFtZTogJ015TmFtZWFibGVGaWxlU3lzdGVtJyxcbiAgICB2cGMsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q0RLKHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6RUZTOjpGaWxlU3lzdGVtJywge1xuICAgIEZpbGVTeXN0ZW1UYWdzOiBbXG4gICAgICB7S2V5OiAnTmFtZScsIFZhbHVlOiAnTXlOYW1lYWJsZUZpbGVTeXN0ZW0nfSxcbiAgICBdLFxuICB9KSk7XG59KTtcblxudGVzdCgnYXV0by1uYW1lZCBpZiBub25lIHByb3ZpZGVkJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGZpbGVTeXN0ZW0gPSBuZXcgRmlsZVN5c3RlbShzdGFjaywgJ0Vmc0ZpbGVTeXN0ZW0nLCB7XG4gICAgdnBjLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVGUzo6RmlsZVN5c3RlbScsIHtcbiAgICBGaWxlU3lzdGVtVGFnczogW1xuICAgICAge0tleTogJ05hbWUnLCBWYWx1ZTogZmlsZVN5c3RlbS5ub2RlLnBhdGh9LFxuICAgIF0sXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCdyZW1vdmFsUG9saWN5IGlzIERFU1RST1knLCAoKSA9PiB7XG4gIG5ldyBGaWxlU3lzdGVtKHN0YWNrLCAnRWZzRmlsZVN5c3RlbScsIHt2cGMsIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWX0pO1xuXG4gIGV4cGVjdENESyhzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkVGUzo6RmlsZVN5c3RlbScsIHtcbiAgICBEZWxldGlvblBvbGljeTogJ0RlbGV0ZScsXG4gICAgVXBkYXRlUmVwbGFjZVBvbGljeTogJ0RlbGV0ZScsXG4gIH0sIFJlc291cmNlUGFydC5Db21wbGV0ZURlZmluaXRpb24pKTtcblxufSk7XG4iXX0=