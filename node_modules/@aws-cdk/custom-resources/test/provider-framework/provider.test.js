"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const lambda = require("@aws-cdk/aws-lambda");
const logs = require("@aws-cdk/aws-logs");
const core_1 = require("@aws-cdk/core");
const cr = require("../../lib");
const util = require("../../lib/provider-framework/util");
require("@aws-cdk/assert/jest");
test('minimal setup', () => {
    // GIVEN
    const stack = new core_1.Stack();
    // WHEN
    new cr.Provider(stack, 'MyProvider', {
        onEventHandler: new lambda.Function(stack, 'MyHandler', {
            code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
            handler: 'index.onEvent',
            runtime: lambda.Runtime.NODEJS_10_X,
        }),
    });
    // THEN
    // framework "onEvent" handler
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.onEvent',
        Environment: { Variables: { USER_ON_EVENT_FUNCTION_ARN: { 'Fn::GetAtt': ['MyHandler6B74D312', 'Arn'] } } },
        Timeout: 900,
    });
    // user "onEvent" handler
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'index.onEvent',
    });
    // no framework "is complete" handler or state machine
    expect(stack).not.toHaveResource('AWS::StepFunctions::StateMachine');
    expect(stack).not.toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.isComplete',
        Timeout: 900,
    });
});
test('if isComplete is specified, the isComplete framework handler is also included', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const handler = new lambda.Function(stack, 'MyHandler', {
        code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
        handler: 'index.onEvent',
        runtime: lambda.Runtime.NODEJS_10_X,
    });
    // WHEN
    new cr.Provider(stack, 'MyProvider', {
        onEventHandler: handler,
        isCompleteHandler: handler,
    });
    // THEN
    // framework "onEvent" handler
    const expectedEnv = {
        Variables: {
            USER_ON_EVENT_FUNCTION_ARN: { 'Fn::GetAtt': ['MyHandler6B74D312', 'Arn'] },
            USER_IS_COMPLETE_FUNCTION_ARN: { 'Fn::GetAtt': ['MyHandler6B74D312', 'Arn'] },
        },
    };
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.onEvent',
        Timeout: 900,
        Environment: {
            Variables: {
                ...expectedEnv.Variables,
                WAITER_STATE_MACHINE_ARN: { Ref: 'MyProviderwaiterstatemachineC1FBB9F9' },
            },
        },
    });
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.isComplete',
        Timeout: 900,
        Environment: expectedEnv,
    });
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.onTimeout',
        Timeout: 900,
        Environment: expectedEnv,
    });
    expect(stack).toHaveResource('AWS::StepFunctions::StateMachine', {
        DefinitionString: {
            'Fn::Join': [
                '',
                [
                    '{"StartAt":"framework-isComplete-task","States":{"framework-isComplete-task":{"End":true,"Retry":[{"ErrorEquals":["States.ALL"],"IntervalSeconds":5,"MaxAttempts":360,"BackoffRate":1}],"Catch":[{"ErrorEquals":["States.ALL"],"Next":"framework-onTimeout-task"}],"Type":"Task","Resource":"',
                    {
                        'Fn::GetAtt': [
                            'MyProviderframeworkisComplete364190E2',
                            'Arn',
                        ],
                    },
                    '"},"framework-onTimeout-task":{"End":true,"Type":"Task","Resource":"',
                    {
                        'Fn::GetAtt': [
                            'MyProviderframeworkonTimeoutD9D96588',
                            'Arn',
                        ],
                    },
                    '"}}}',
                ],
            ],
        },
    });
});
test('fails if "queryInterval" and/or "totalTimeout" are set without "isCompleteHandler"', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const handler = new lambda.Function(stack, 'MyHandler', {
        code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
        handler: 'index.onEvent',
        runtime: lambda.Runtime.NODEJS_10_X,
    });
    // THEN
    expect(() => new cr.Provider(stack, 'provider1', {
        onEventHandler: handler,
        queryInterval: core_1.Duration.seconds(10),
    })).toThrow(/\"queryInterval\" and \"totalTimeout\" can only be configured if \"isCompleteHandler\" is specified. Otherwise, they have no meaning/);
    expect(() => new cr.Provider(stack, 'provider2', {
        onEventHandler: handler,
        totalTimeout: core_1.Duration.seconds(100),
    })).toThrow(/\"queryInterval\" and \"totalTimeout\" can only be configured if \"isCompleteHandler\" is specified. Otherwise, they have no meaning/);
});
describe('retry policy', () => {
    it('default is 30 minutes timeout in 5 second intervals', () => {
        const policy = util.calculateRetryPolicy();
        expect(policy.backoffRate).toStrictEqual(1);
        expect(policy.interval && policy.interval.toSeconds()).toStrictEqual(5);
        expect(policy.maxAttempts).toStrictEqual(360);
    });
    it('if total timeout and query interval are the same we will have one attempt', () => {
        const policy = util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.minutes(5),
            queryInterval: core_1.Duration.minutes(5),
        });
        expect(policy.maxAttempts).toStrictEqual(1);
    });
    it('fails if total timeout cannot be integrally divided', () => {
        expect(() => util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.seconds(100),
            queryInterval: core_1.Duration.seconds(75),
        })).toThrow(/Cannot determine retry count since totalTimeout=100s is not integrally dividable by queryInterval=75s/);
    });
    it('fails if interval > timeout', () => {
        expect(() => util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.seconds(5),
            queryInterval: core_1.Duration.seconds(10),
        })).toThrow(/Cannot determine retry count since totalTimeout=5s is not integrally dividable by queryInterval=10s/);
    });
});
describe('log retention', () => {
    it('includes a log rotation lambda when present', () => {
        // GIVEN
        const stack = new core_1.Stack();
        // WHEN
        new cr.Provider(stack, 'MyProvider', {
            onEventHandler: new lambda.Function(stack, 'MyHandler', {
                code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
                handler: 'index.onEvent',
                runtime: lambda.Runtime.NODEJS_10_X,
            }),
            logRetention: logs.RetentionDays.ONE_WEEK,
        });
        // THEN
        expect(stack).toHaveResource('Custom::LogRetention', {
            LogGroupName: {
                'Fn::Join': [
                    '',
                    [
                        '/aws/lambda/',
                        {
                            Ref: 'MyProviderframeworkonEvent9AF5C387',
                        },
                    ],
                ],
            },
            RetentionInDays: 7,
        });
    });
    it('does not include the log rotation lambda otherwise', () => {
        // GIVEN
        const stack = new core_1.Stack();
        // WHEN
        new cr.Provider(stack, 'MyProvider', {
            onEventHandler: new lambda.Function(stack, 'MyHandler', {
                code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
                handler: 'index.onEvent',
                runtime: lambda.Runtime.NODEJS_10_X,
            }),
        });
        // THEN
        expect(stack).not.toHaveResource('Custom::LogRetention');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInByb3ZpZGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsOENBQThDO0FBQzlDLDBDQUEwQztBQUMxQyx3Q0FBZ0Q7QUFDaEQsZ0NBQWdDO0FBQ2hDLDBEQUEwRDtBQUUxRCxnQ0FBOEI7QUFFOUIsSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDekIsUUFBUTtJQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7SUFFMUIsT0FBTztJQUNQLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFO1FBQ25DLGNBQWMsRUFBRSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRTtZQUN0RCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsNkNBQTZDLENBQUMsQ0FBQztZQUNoRyxPQUFPLEVBQUUsZUFBZTtZQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1NBQ3BDLENBQUM7S0FDSCxDQUFDLENBQUM7SUFFSCxPQUFPO0lBRVAsOEJBQThCO0lBQzlCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxjQUFjLENBQUMsdUJBQXVCLEVBQUU7UUFDcEQsT0FBTyxFQUFFLG1CQUFtQjtRQUM1QixXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSwwQkFBMEIsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFFLG1CQUFtQixFQUFFLEtBQUssQ0FBRSxFQUFFLEVBQUUsRUFBRTtRQUM1RyxPQUFPLEVBQUUsR0FBRztLQUNiLENBQUMsQ0FBQztJQUVILHlCQUF5QjtJQUN6QixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsY0FBYyxDQUFDLHVCQUF1QixFQUFFO1FBQ3BE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QyxLQUFLLEVBQUUsV0FBVyxFQUFFO2dCQUN0RCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsNkNBQTZDLENBQUMsQ0FBQztnQkFDaEcsT0FBTyxFQUFFLGVBQWU7Z0JBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7YUFDcEMsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE9BQU87UUFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQzNELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tICdAYXdzLWNkay9hd3MtbG9ncyc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIGNyIGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvdXRpbCc7XG5cbmltcG9ydCAnQGF3cy1jZGsvYXNzZXJ0L2plc3QnO1xuXG50ZXN0KCdtaW5pbWFsIHNldHVwJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIC8vIFdIRU5cbiAgbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAnTXlQcm92aWRlcicsIHtcbiAgICBvbkV2ZW50SGFuZGxlcjogbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ015SGFuZGxlcicsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi9pbnRlZ3JhdGlvbi10ZXN0LWZpeHR1cmVzL3MzLWZpbGUtaGFuZGxlcicpKSxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMF9YLFxuICAgIH0pLFxuICB9KTtcblxuICAvLyBUSEVOXG5cbiAgLy8gZnJhbWV3b3JrIFwib25FdmVudFwiIGhhbmRsZXJcbiAgZXhwZWN0KHN0YWNrKS50b0hhdmVSZXNvdXJjZSgnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge1xuICAgIEhhbmRsZXI6ICdmcmFtZXdvcmsub25FdmVudCcsXG4gICAgRW52aXJvbm1lbnQ6IHsgVmFyaWFibGVzOiB7IFVTRVJfT05fRVZFTlRfRlVOQ1RJT05fQVJOOiB7ICdGbjo6R2V0QXR0JzogWyAnTXlIYW5kbGVyNkI3NEQzMTInLCAnQXJuJyBdIH0gfSB9LFxuICAgIFRpbWVvdXQ6IDkwMCxcbiAgfSk7XG5cbiAgLy8gdXNlciBcIm9uRXZlbnRcIiBoYW5kbGVyXG4gIGV4cGVjdChzdGFjaykudG9IYXZlUmVzb3VyY2UoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHtcbiAgICBIYW5kbGVyOiAnaW5kZXgub25FdmVudCcsXG4gIH0pO1xuXG4gIC8vIG5vIGZyYW1ld29yayBcImlzIGNvbXBsZXRlXCIgaGFuZGxlciBvciBzdGF0ZSBtYWNoaW5lXG4gIGV4cGVjdChzdGFjaykubm90LnRvSGF2ZVJlc291cmNlKCdBV1M6OlN0ZXBGdW5jdGlvbnM6OlN0YXRlTWFjaGluZScpO1xuICBleHBlY3Qoc3RhY2spLm5vdC50b0hhdmVSZXNvdXJjZSgnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge1xuICAgIEhhbmRsZXI6ICdmcmFtZXdvcmsuaXNDb21wbGV0ZScsXG4gICAgVGltZW91dDogOTAwLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdpZiBpc0NvbXBsZXRlIGlzIHNwZWNpZmllZCwgdGhlIGlzQ29tcGxldGUgZnJhbWV3b3JrIGhhbmRsZXIgaXMgYWxzbyBpbmNsdWRlZCcsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdNeUhhbmRsZXInLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuL2ludGVncmF0aW9uLXRlc3QtZml4dHVyZXMvczMtZmlsZS1oYW5kbGVyJykpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBuZXcgY3IuUHJvdmlkZXIoc3RhY2ssICdNeVByb3ZpZGVyJywge1xuICAgIG9uRXZlbnRIYW5kbGVyOiBoYW5kbGVyLFxuICAgIGlzQ29tcGxldGVIYW5kbGVyOiBoYW5kbGVyLFxuICB9KTtcblxuICAvLyBUSEVOXG5cbiAgLy8gZnJhbWV3b3JrIFwib25FdmVudFwiIGhhbmRsZXJcbiAgY29uc3QgZXhwZWN0ZWRFbnYgPSB7XG4gICAgVmFyaWFibGVzOiB7XG4gICAgICBVU0VSX09OX0VWRU5UX0ZVTkNUSU9OX0FSTjogeyAnRm46OkdldEF0dCc6IFsnTXlIYW5kbGVyNkI3NEQzMTInLCAnQXJuJyBdIH0sXG4gICAgICBVU0VSX0lTX0NPTVBMRVRFX0ZVTkNUSU9OX0FSTjogeyAnRm46OkdldEF0dCc6IFsgJ015SGFuZGxlcjZCNzREMzEyJywgJ0FybicgXSB9LFxuICAgIH0sXG4gIH07XG5cbiAgZXhwZWN0KHN0YWNrKS50b0hhdmVSZXNvdXJjZSgnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge1xuICAgIEhhbmRsZXI6ICdmcmFtZXdvcmsub25FdmVudCcsXG4gICAgVGltZW91dDogOTAwLFxuICAgIEVudmlyb25tZW50OiB7XG4gICAgICBWYXJpYWJsZXM6IHtcbiAgICAgICAgLi4uZXhwZWN0ZWRFbnYuVmFyaWFibGVzLFxuICAgICAgICBXQUlURVJfU1RBVEVfTUFDSElORV9BUk46IHsgUmVmOiAnTXlQcm92aWRlcndhaXRlcnN0YXRlbWFjaGluZUMxRkJCOUY5JyB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2spLnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogJ2ZyYW1ld29yay5pc0NvbXBsZXRlJyxcbiAgICBUaW1lb3V0OiA5MDAsXG4gICAgRW52aXJvbm1lbnQ6IGV4cGVjdGVkRW52LFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2spLnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogJ2ZyYW1ld29yay5vblRpbWVvdXQnLFxuICAgIFRpbWVvdXQ6IDkwMCxcbiAgICBFbnZpcm9ubWVudDogZXhwZWN0ZWRFbnYsXG4gIH0pO1xuXG4gIGV4cGVjdChzdGFjaykudG9IYXZlUmVzb3VyY2UoJ0FXUzo6U3RlcEZ1bmN0aW9uczo6U3RhdGVNYWNoaW5lJywge1xuICAgIERlZmluaXRpb25TdHJpbmc6IHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAne1wiU3RhcnRBdFwiOlwiZnJhbWV3b3JrLWlzQ29tcGxldGUtdGFza1wiLFwiU3RhdGVzXCI6e1wiZnJhbWV3b3JrLWlzQ29tcGxldGUtdGFza1wiOntcIkVuZFwiOnRydWUsXCJSZXRyeVwiOlt7XCJFcnJvckVxdWFsc1wiOltcIlN0YXRlcy5BTExcIl0sXCJJbnRlcnZhbFNlY29uZHNcIjo1LFwiTWF4QXR0ZW1wdHNcIjozNjAsXCJCYWNrb2ZmUmF0ZVwiOjF9XSxcIkNhdGNoXCI6W3tcIkVycm9yRXF1YWxzXCI6W1wiU3RhdGVzLkFMTFwiXSxcIk5leHRcIjpcImZyYW1ld29yay1vblRpbWVvdXQtdGFza1wifV0sXCJUeXBlXCI6XCJUYXNrXCIsXCJSZXNvdXJjZVwiOlwiJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgICAgICAgJ015UHJvdmlkZXJmcmFtZXdvcmtpc0NvbXBsZXRlMzY0MTkwRTInLFxuICAgICAgICAgICAgICAnQXJuJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnXCJ9LFwiZnJhbWV3b3JrLW9uVGltZW91dC10YXNrXCI6e1wiRW5kXCI6dHJ1ZSxcIlR5cGVcIjpcIlRhc2tcIixcIlJlc291cmNlXCI6XCInLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAnTXlQcm92aWRlcmZyYW1ld29ya29uVGltZW91dEQ5RDk2NTg4JyxcbiAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ1wifX19JyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnZmFpbHMgaWYgXCJxdWVyeUludGVydmFsXCIgYW5kL29yIFwidG90YWxUaW1lb3V0XCIgYXJlIHNldCB3aXRob3V0IFwiaXNDb21wbGV0ZUhhbmRsZXJcIicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdNeUhhbmRsZXInLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuL2ludGVncmF0aW9uLXRlc3QtZml4dHVyZXMvczMtZmlsZS1oYW5kbGVyJykpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoKCkgPT4gbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAncHJvdmlkZXIxJywge1xuICAgIG9uRXZlbnRIYW5kbGVyOiBoYW5kbGVyLFxuICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoMTApLFxuICB9KSkudG9UaHJvdygvXFxcInF1ZXJ5SW50ZXJ2YWxcXFwiIGFuZCBcXFwidG90YWxUaW1lb3V0XFxcIiBjYW4gb25seSBiZSBjb25maWd1cmVkIGlmIFxcXCJpc0NvbXBsZXRlSGFuZGxlclxcXCIgaXMgc3BlY2lmaWVkLiBPdGhlcndpc2UsIHRoZXkgaGF2ZSBubyBtZWFuaW5nLyk7XG5cbiAgZXhwZWN0KCgpID0+IG5ldyBjci5Qcm92aWRlcihzdGFjaywgJ3Byb3ZpZGVyMicsIHtcbiAgICBvbkV2ZW50SGFuZGxlcjogaGFuZGxlcixcbiAgICB0b3RhbFRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoMTAwKSxcbiAgfSkpLnRvVGhyb3coL1xcXCJxdWVyeUludGVydmFsXFxcIiBhbmQgXFxcInRvdGFsVGltZW91dFxcXCIgY2FuIG9ubHkgYmUgY29uZmlndXJlZCBpZiBcXFwiaXNDb21wbGV0ZUhhbmRsZXJcXFwiIGlzIHNwZWNpZmllZC4gT3RoZXJ3aXNlLCB0aGV5IGhhdmUgbm8gbWVhbmluZy8pO1xufSk7XG5cbmRlc2NyaWJlKCdyZXRyeSBwb2xpY3knLCAoKSA9PiB7XG4gIGl0KCdkZWZhdWx0IGlzIDMwIG1pbnV0ZXMgdGltZW91dCBpbiA1IHNlY29uZCBpbnRlcnZhbHMnLCAoKSA9PiB7XG4gICAgY29uc3QgcG9saWN5ID0gdXRpbC5jYWxjdWxhdGVSZXRyeVBvbGljeSgpO1xuICAgIGV4cGVjdChwb2xpY3kuYmFja29mZlJhdGUpLnRvU3RyaWN0RXF1YWwoMSk7XG4gICAgZXhwZWN0KHBvbGljeS5pbnRlcnZhbCAmJiBwb2xpY3kuaW50ZXJ2YWwudG9TZWNvbmRzKCkpLnRvU3RyaWN0RXF1YWwoNSk7XG4gICAgZXhwZWN0KHBvbGljeS5tYXhBdHRlbXB0cykudG9TdHJpY3RFcXVhbCgzNjApO1xuICB9KTtcblxuICBpdCgnaWYgdG90YWwgdGltZW91dCBhbmQgcXVlcnkgaW50ZXJ2YWwgYXJlIHRoZSBzYW1lIHdlIHdpbGwgaGF2ZSBvbmUgYXR0ZW1wdCcsICgpID0+IHtcbiAgICBjb25zdCBwb2xpY3kgPSB1dGlsLmNhbGN1bGF0ZVJldHJ5UG9saWN5KHtcbiAgICAgIHRvdGFsVGltZW91dDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgfSk7XG4gICAgZXhwZWN0KHBvbGljeS5tYXhBdHRlbXB0cykudG9TdHJpY3RFcXVhbCgxKTtcbiAgfSk7XG5cbiAgaXQoJ2ZhaWxzIGlmIHRvdGFsIHRpbWVvdXQgY2Fubm90IGJlIGludGVncmFsbHkgZGl2aWRlZCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gdXRpbC5jYWxjdWxhdGVSZXRyeVBvbGljeSh7XG4gICAgICB0b3RhbFRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoMTAwKSxcbiAgICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoNzUpLFxuICAgIH0pKS50b1Rocm93KC9DYW5ub3QgZGV0ZXJtaW5lIHJldHJ5IGNvdW50IHNpbmNlIHRvdGFsVGltZW91dD0xMDBzIGlzIG5vdCBpbnRlZ3JhbGx5IGRpdmlkYWJsZSBieSBxdWVyeUludGVydmFsPTc1cy8pO1xuICB9KTtcblxuICBpdCgnZmFpbHMgaWYgaW50ZXJ2YWwgPiB0aW1lb3V0JywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiB1dGlsLmNhbGN1bGF0ZVJldHJ5UG9saWN5KHtcbiAgICAgIHRvdGFsVGltZW91dDogRHVyYXRpb24uc2Vjb25kcyg1KSxcbiAgICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoMTApLFxuICAgIH0pKS50b1Rocm93KC9DYW5ub3QgZGV0ZXJtaW5lIHJldHJ5IGNvdW50IHNpbmNlIHRvdGFsVGltZW91dD01cyBpcyBub3QgaW50ZWdyYWxseSBkaXZpZGFibGUgYnkgcXVlcnlJbnRlcnZhbD0xMHMvKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2xvZyByZXRlbnRpb24nLCAoKSA9PiB7XG4gIGl0KCdpbmNsdWRlcyBhIGxvZyByb3RhdGlvbiBsYW1iZGEgd2hlbiBwcmVzZW50JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgY3IuUHJvdmlkZXIoc3RhY2ssICdNeVByb3ZpZGVyJywge1xuICAgICAgb25FdmVudEhhbmRsZXI6IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdNeUhhbmRsZXInLCB7XG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi9pbnRlZ3JhdGlvbi10ZXN0LWZpeHR1cmVzL3MzLWZpbGUtaGFuZGxlcicpKSxcbiAgICAgICAgaGFuZGxlcjogJ2luZGV4Lm9uRXZlbnQnLFxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgICAgIH0pLFxuICAgICAgbG9nUmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXMuT05FX1dFRUssXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrKS50b0hhdmVSZXNvdXJjZSgnQ3VzdG9tOjpMb2dSZXRlbnRpb24nLCB7XG4gICAgICBMb2dHcm91cE5hbWU6IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICcvYXdzL2xhbWJkYS8nLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBSZWY6ICdNeVByb3ZpZGVyZnJhbWV3b3Jrb25FdmVudDlBRjVDMzg3JyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgICBSZXRlbnRpb25JbkRheXM6IDcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdkb2VzIG5vdCBpbmNsdWRlIHRoZSBsb2cgcm90YXRpb24gbGFtYmRhIG90aGVyd2lzZScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAnTXlQcm92aWRlcicsIHtcbiAgICAgIG9uRXZlbnRIYW5kbGVyOiBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnTXlIYW5kbGVyJywge1xuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4vaW50ZWdyYXRpb24tdGVzdC1maXh0dXJlcy9zMy1maWxlLWhhbmRsZXInKSksXG4gICAgICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEwX1gsXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2spLm5vdC50b0hhdmVSZXNvdXJjZSgnQ3VzdG9tOjpMb2dSZXRlbnRpb24nKTtcbiAgfSk7XG59KTtcbiJdfQ==